<!DOCTYPE html>
<html>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Protest+Guerrilla&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Protest+Guerrilla&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">

<head>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

    <link rel="icon" type="image/x-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Circle_-_black_simple.svg/800px-Circle_-_black_simple.svg.png">
    <style>
        :root {
            --mainBG: #1a1817;
            --colorBG: #1c1918;
            --colorTrap: #0f0f0f;
            --colorText: #b33f19;
            --colorHighlights: #e3ded1;
        }

        /*hub:{
                colorBG:"#1c1918",
                colorTrap:"#0f0f0f",
                colorHighlights:"#e3ded1",
            },*/

        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background: var(--mainBG);
            color: var(--colorText);
            font-size: .8VW;
            /*             font-family: "Protest Guerrilla";*/
            font-family: "Quicksand", sans-serif;
            font-weight: 600;

            /*            color: var(--colorText);*/

        }


        canvas {
            width: 100VW;
            height: 100VH;
            background: var(--colorBG);
            margin: 2vw;
            margin-top: 3VH;
            display: block;
            border: 4px solid var(--colorTrap);
        }

        div {
            background: var(--colorBG);
            /*            display: inline-block;*/
            margin-top: 3VH;
            /*            float: left;*/
            position: absolute;
            left: 25%;
            width: 50VW;
            height: 40VH;
            border: 4px solid var(--colorTrap);
            overflow-y: auto;
            overflow-x: auto;
            display: flex;
            flex-direction: column-reverse;
        }

        .divSplit {
            background: var(--colorBG);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0VH;
            position: inherit;
            left: 0%;
            width: 0VW;
            height: 80%;
            border: 4px solid var(--colorTrap);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            margin-left: 0VW;
            margin-right: 0VW;
            text-align: center;
            color: var(--colorText);
        }

        .stats {
            background: var(--colorBG);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0VH;
            position: inherit;
            left: 0%;
            width: 0VW;
            height: 80%;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            margin-left: 0VW;
            margin-right: 0VW;
            text-align: center;
        }

        #activityLog {
            display: flex;
            overflow-y: scroll;
            overflow-x: hidden;
            flex-direction: column-reverse;
            margin-left: 0VW;
            margin-right: 0VW;
            text-align: center;
        }

        #storyLog {
            display: flex;
            overflow-y: scroll;
            overflow-x: hidden;
            flex-direction: column;
            margin-left: 0VW;
            margin-right: 0VW;
            text-align: center;
            left: 29.75%;
            top: 42VH;
            width: 44.75VW;
            height: 14.5VH;
            padding-top: 2VH;
            padding-bottom: 1VH;
            padding-left: 1vw;
            padding-right: 1vw;
        }

        .triangle {
            width: 0;
            background: transparent;
            border: transparent;
            border-bottom: 20VH solid var(--colorText);
            border-left: 5.25VW solid transparent;
            border-right: 5.25VW solid transparent;
        }

        .inTriangle {
            left: 50%;
            margin: 0;
            text-align: center;
            position: flex;
            color: var(--colorText);
        }

        .line {
            width: 0;
            background: transparent;
            border: transparent;
            border-bottom: .2VH solid #e3ded1;
        }

        #inputBox:focus {
            outline-style: solid;
            outline-color: var(--colorText);
        }

        #inputBox::selection {
            background: #e3ded1;
        }

        .splitline {
            border-style: solid;
            border-width: .01VW;
            border-color: var(--colorText);
            width: 85%;
        }

    </style>
</head>

<body>

    <canvas id="canvaLeft" style="width: 20VW;height: 90VH;float:left;">
        Your browser does not support the HTML canvas tag.</canvas>
    <canvas id="canvaRight" style="width: 20VW;height: 90VH;float:right;">
        Your browser does not support the HTML canvas tag.</canvas>

    <!--LOG-->
    <div style="left: 23%;width: 53.5VW;height: 40VH;">
        <p id="combatLog"></p>
    </div>

    <!--STATUS-->
    <!--    <div class="triangle" style="left: 29.75%;width: 30VW;height: 0VH;top:41%;color:white;">-->

    <!--    </div>-->
    <div style="position: absolute;left: 23%;top:42VH;width: 6VW;height: 12VH; display: inline-flex;padding-top: 0VH;overflow: hidden;justify-content: center;">
        <p id="enemyStatus" class="inTriangle" style="top: 20%;"></p>

        <hr style="" class="splitline">

        <p id="playerStatus" class="inTriangle" style="top: 40%;"></p>
    </div>
    <!--    <div class="line" style="top: 10%;width:30vw;left:34.75%;"></div>-->

    <div style="left: 29.75%;top:61%;width: 40VW;height: 15VH;padding-bottom: 1VH;" id="activityLog"></div>
    <div style="" id="storyLog"></div>

    <div style="left: 30%;top:78.75%;width: 40VW;height: 7VH;flex-direction: column;overflow: hidden;border: transparent 4px;background: transparent;">
        <div style="width: 22.5%; float:left;left: 0%;" id="action1" class="divSplit" onclick="clickall(action1List)">
            1
        </div>
        <div style="width: 22.5%; float:left;left: 25%;" id="action2" class="divSplit" onclick="clickall(action2List)">
            2
        </div>
        <div style="width: 22.5%; float:right;right: 25%;left: auto;" id="action3" class="divSplit" onclick="clickall(action3List)">
            3
        </div>
        <div style="width: 22.5%; float:right;right: 0%;left: auto;" id="action4" class="divSplit" onclick="clickall(action4List)">
            4
        </div>
    </div>
    <div style="left: 30%;top:86%;width: 40VW;height: 7VH;flex-direction: column;overflow: hidden;border: transparent 4px;background: transparent;">
        <div style="width: 22.5%; float:left;left: 0%;" id="action5" class="divSplit" onclick="clickall(action5List)">
            5
        </div>
        <div style="width: 22.5%; float:left;left: 25%;" id="action6" class="divSplit" onclick="clickall(action6List)">
            6
        </div>
        <div style="width: 22.5%; float:right;right: 25%;left: auto;" id="action7" class="divSplit" onclick="clickall(action7List)">
            7
        </div>
        <div style="width: 22.5%; float:right;right: 0%;left: auto;" id="action8" class="divSplit" onclick="clickall(action8List)">
            8
        </div>
    </div>


    <div style="left: 23%;top:61%;width: 6VW;height: 28VH;padding-bottom: 1VH;padding-top: 1VH;flex-direction: column;" id="playerStats">
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="SP" class="stats">
            0
        </div>
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="attack" class="stats">
            0
        </div>
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="maxHealth" class="stats">
            0
        </div>
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="defense" class="stats">
            0
        </div>
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="AP" class="stats">
            0
        </div>
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="level" class="stats">
            0
        </div>
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="floor" class="stats">
            0
        </div>
    </div>
    <input style="left: 23%;top:58.25%;width: 6VW;height: 2VH;padding-bottom: 1VH;padding-top: 1VH;position: absolute; padding:0;padding-top: 1VH;padding-bottom: 1VH;" class="divSplit" type="text" id="inputBox" name="inputBox" onkeypress="return true;" placeholder="">

    <div style="left: 70.5%;top:61%;width: 6VW;height: 29VH;padding-bottom: 1VH;" id="enemyStats">
        <div style="width: 100%;height:4VH; float:left;left: 0%;border:none;position:relative;" id="coins" class="stats">
            0
        </div>
    </div>





    <script>
        //       demon castle, new skills, save data fixer, setting + turn off panels, summon, sacrifice (damage buff), curse (defense debuff), The great bison(summon quest), the witch(curse quest), respec, bird colonizers, feather icon for harpy unlock

        var r = document.querySelector(':root');

        function blurAll() {
            var tmp = document.createElement("input");
            document.body.appendChild(tmp);
            tmp.focus();
            document.body.removeChild(tmp);
        }

        function runFunction(functionName, Parameters = "") {
            window[functionName](window[Parameters])
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function isInteger(value) {
            if (parseInt(value, 10).toString() === value) {
                return true
            }
            return false;
        }

        function activityLogAdd(text) {
            combatLog += text;
            document.getElementById("combatLog").innerHTML = combatLog;
        }

        function combatLogAdd(text) {
            activityLog += text;
            document.getElementById("activityLog").innerHTML = activityLog;
        }

        function generateFlames(selectedCanvas) {
            function getMousePos(canvas, evt) {
                var rect = canvas.getBoundingClientRect();
                return {
                    x: evt.clientX - rect.left,
                    y: evt.clientY - rect.top
                };
            }

            function makeMouse(evt) {
                pos = getMousePos(c, evt);
            }

            function flameRefresh() {
                ctx.clearRect(0, 0, c.width, c.height);
                ctx.beginPath();
                var region = new Path2D();

                for (let index in flames) {
                    if (flames[index].death == false) {

                        moveFlame(index);
                        flameLifetime(index);
                        region.moveTo(flames[index].path.at(-1)[0], flames[index].path.at(-1)[1]);
                        for (let lencount in flames[index].path) {
                            if (lencount !== flames[index].path.length) {
                                region.lineTo(flames[index].path.at(lencount)[0], flames[index].path.at(lencount)[1]);
                            }
                        }

                    } else {
                        if (flames[index].decayCount <= 0) {
                            for (let x in [...Array(getRandomInt(1, 2)).keys()]) { // DECAY RATE
                                if (flames[index] !== undefined) {

                                    flames[index].path.splice(0, 1);

                                }
                                if (flames[index] !== undefined) {
                                    if (flames[index].path.length <= 0 && flames[index] !== undefined) {
                                        flames.splice(index, 1);
                                    } else {
                                        region.moveTo(flames[index].path.at(-1)[0], flames[index].path.at(-1)[1]);
                                        for (let lencount in flames[index].path) {
                                            if (lencount !== flames[index].path.length) {
                                                region.lineTo(flames[index].path.at(lencount)[0], flames[index].path.at(lencount)[1]);
                                            }
                                        }
                                    }
                                }
                            }
                        } else {
                            flames[index].decayCount -= 1
                            region.moveTo(flames[index].path.at(-1)[0], flames[index].path.at(-1)[1]);
                            for (let lencount in flames[index].path) {
                                if (lencount !== flames[index].path.length) {
                                    region.lineTo(flames[index].path.at(lencount)[0], flames[index].path.at(lencount)[1]);
                                }
                            }
                        }
                    }

                }

                if (getRandomInt(1, 75) == 1) {
                    for (let x in [...Array(getRandomInt(1, 2)).keys()]) {
                        createFlame();
                    }
                }
                //                document.getElementById("combatLog").innerHTML = JSON.stringify(flames);
                region.closePath();
                if (areaTraits[player.location] !== undefined) {
                    var fillColor = areaTraits[player.location].colorText;
                } else {
                    var fillColor = areaTraits.hub.colorText
                }
                ctx.globalAlpha = 0.75
                ctx.fillStyle = fillColor;
                ctx.fill(region); //, "evenodd"
            }

            function createFlame() {
                let pathA = getRandomInt(0, c.width);
                if (flames.length < 5) {
                    flames.push({
                        path: [
                            [pathA, (c.height + 1)],
                            [pathA, (c.height) + 1]
                        ],
                        color: "rgb(71, 138, 161)",
                        //                    color:
                        speedx: 0,
                        speedy: getRandomInt(5, 8),
                        acceleration: 0,
                        acceleration_scalar: 2,
                        maxHeight: 0,
                        limit: 100,
                        death: false,
                        decayCount: 30,
                    })
                }
            }

            function moveFlame(index) {
                //                flames[index].acceleration = getRandomInt(0, flames[index].acceleration_scalar) - (flames[index].acceleration_scalar / 2.5);
                flames[index].acceleration += getRandomInt((flames[index].acceleration_scalar * -1), (flames[index].acceleration_scalar * 1))
                flames[index].speedx += flames[index].acceleration;

                if (flames[index].speedx >= flames[index].limit || flames[index].speedx <= -1 * (flames[index].limit)) {
                    flames[index].speedx = 0;
                    flames[index].acceleration = 0;
                }
                var rx = flames[index].speedx;
                var ry = flames[index].speedy;

                moveFlamePosAttacher = [];
                moveFlamePosAttacher[0] = (flames[index].path.at(-1)[0] + rx);
                moveFlamePosAttacher[1] = (flames[index].path.at(-1)[1] - ry + ((Math.sign(pos.y - flames[index].path.at(-1)[1]) * (c.height / 1000)) * (Math.log(Math.abs(pos.y - flames[index].path.at(-1)[1])))) * 1);
                flames[index].path.push(moveFlamePosAttacher);

            }

            function flameLifetime(index) {
                if (flames[index].path.at(-1)[1] <= Math.floor(flames[index].maxHeight) || flames[index].path.at(-1)[1] >= c.height || flames[index].path.at(-1)[0] <= 0 || flames[index].path.at(-1)[0] >= c.width) {
                    flames[index].death = true;
                }
            }
            var pos = {
                x: 0,
                y: 0
            }
            const flames = []
            var c = document.getElementById(selectedCanvas);
            c.width = window.innerWidth;
            c.height = window.innerHeight;
            createFlame()
            var ctx = c.getContext("2d");
            let updateIntervalId_b = setInterval(flameRefresh, 50);
        }

        generateFlames("canvaLeft")
        generateFlames("canvaRight")


        var dungeonNameList = [
            "slime",
            "Josh",
            "George",
            "ogre",
            "cheese rat",
            "hellhound",
            "goblin",
            "hemo-goblin",
            "land shark",
            "psychopath",
            "cultist",
            "rat pile",
            "Filler Mike"
        ]
        var combatLog = "";
        var activityLog = "";
        var player = {
            abilities: [1, 2],
            xp: 0,
            neededXp: 5,
            maxHealth: 1,
            health: 5,
            attack: 1,
            defense: 1,
            skillUsesMax: 3,
            skillUses: 3,
            attributePoints: 3,
            location: "hub",
            subArea: "",
            fightLocation: "",
            coins: 0,
            floor: 1,
            level: 1,
            startingFloor: 1,
            choice: false,
            completedStories: [],
            storyLocation: "",
            items: [],
            input: '',
            harpy: false,
            harpyDamage: 1,
            strikeDamage: 7.5,
            heal: 1,
            curseStrength: 1,

        };
        var playerBackup = JSON.parse(JSON.stringify(player))

        var enemy = {
            name: "Filler Mike",
            health: 1,
            attack: 1,
            defense: 1,
            status: "dead"
        };
        var action1List = {
            actionid: "action1",
            hub: ["|1| Enter Dungeon", "fight", "dungeon"],
            fight: ["|1| Attack", "attack"],
            distrib: ["|1| add to health", "addtohp"],
            flightCity: ["|1| Go to shop", "goShop"],
            settings: ["|1| Save Data", "saveGame"],
        }
        var action2List = {
            actionid: "action2",
            hub: ["", ""],
            fight: ["|2| Strike", "strike"],
            distrib: ["|2| add to defense", "addtodef"],
            flightCity: ["|2| investigate a strange water drain", "storyIncrement", "flightCityHarpy"],
            settings: ["|2| Load Data", "loadGame"],
        }
        var action3List = {
            actionid: "action3",
            hub: ["|3| Distribute Attribute Points", "attributeDistribute"],
            fight: ["", ""],
            distrib: ["|3| add to attack", "addtoatt"],
            settings: ["|3| Clear Data", "clearGame"],
        }
        var action4List = {
            actionid: "action4",
            hub: [" ", ""],
            fight: [" ", ""],
            distrib: ["|4| add to skill uses", "addtosp"],
        }
        var action5List = {
            actionid: "action5",
            hub: [" ", ""],
            fight: [" ", ""],
            distrib: ["|5| Exit", "goHub"],
        }
        var action6List = {
            actionid: "action6",
            hub: [" ", ""],
            fight: [" ", ""],
        }
        var action7List = {
            actionid: "action7",
            hub: [" ", ""],
            fight: [" ", ""]
        }
        var action8List = {
            actionid: "action8",
            hub: ["|8| Settings", "goSettings"],
            fight: ["|8| Exit Dungeon", "goHub"],
            flightCity: ["|8| Go to Hub", "goHub"],
            settings: ["|8| Go to Hub", "goHub"],
        }

        var levelMilestones = {
            3: ["Heal! This ability heals you based on your defense, and ignores your max health!", "unlockHeal"],
            6: ["Caelum Civitatem, Holy City of Flight!", "unlockFlightCity"]
            //            12:sacrifice = damage based on maxHealth
        }
        var fightAreas = {
            "dungeon": [dungeonNameList, [8, 12]]
        }
        var areaTraits = {
            hub: {
                mainBG: "#1a1817",
                colorBG: "#1c1918",
                colorTrap: "#0f0f0f",
                colorText: "#b33f19",
                colorHighlights: "#e3ded1",
            },
            fight: {
                mainBG: "#1a1817",
                colorBG: "#181615",
                colorTrap: "#0f0f0f",
                colorText: "#b33f19",
                colorHighlights: "#e3ded1",
            },
            //            uhhh: {
            //                mainBG: "#1a1817",
            //                colorBG: "#1c1918",
            //                colorTrap: "#0f0f0f",
            //                colorText: "white",
            //                colorHighlights: "#e3ded1",
            //            },
            flightCity: {
                mainBG: "black",
                colorBG: "#040E1F",
                colorTrap: "black",
                colorText: "white",
                colorHighlights: "#e3ded1",
            },
            shop: {
                mainBG: "black",
                colorBG: "#040E1F",
                colorTrap: "black",
                colorText: "white",
                colorHighlights: "#e3ded1",
            },
        }
        var stories = { //1 - text displayed, 2 - increment, 3 - choice sender location, 4 - function (optional)
            // quickname:['text',yes,no] if in "here" do not run as function
            flightCityHarpy: { //   :["",["",""]],
                onclear: 'harpyClear',
                currentStoryPosition: "start",
                start: ["You find a suspicious water drain in the floating city, elevated, and serving no purpose. [y/n to continue]", ["firstQuestion", "firstQuestion"]],
                firstQuestion: ["Do you choose to enter it?", ["enterGutter", "leave"]],
                enterGutter: ["You crawl into the drain. It opens up into a larger tunnel. walking through it, the air feels heavy. Eventually you approach an opening, a large space with a shrine to a harpy, wings folded over its eyes. Do you kneel to it?", ["kneel", "dontkneel"]],
                dontkneel: ["You do nothing, and leave the way you came. ", ["leave", "leave"]],
                leave: "gohub",
                dontEnterGutter: "goHub",
                kneel: ["You kneel, and it feels as if the shrine to the harpy, it's massive stone carvings, become alive, breathing. It is suffering, and wants to be released, yet it cannot feel, and knows not of pain. The wings open, revealing a cage within its skull. Hidden in a dark corner, lays a feeble adolescent harpy, malnourished and dying. Do you choose to help it?", ["helpharpy", "donthelpharpy"]],
                donthelpharpy: ["You do not help the harpy. You leave, feeling nothing. Have you felt guilt over this void of empathy?", ["leave", "leave"]],
                helpharpy: ["You climb the statue of the large shrine, tearing out the rusted bars of the cage. Grabbing the harpy, you return to your domain, and nurse it back to health.", ["finale", "finale"]],
                finale: "addHarpy"
            },
        }

        var items = [
            ["Charm of Attack", simpleAdd, "attack, 1"],
            ["Charm of Defense", simpleAdd, "defense, 1"],
            ["Charm of Health", simpleAdd, "maxHealth, 1"],
            ["Charm of Skill", simpleAdd, "skillUsesMax, 1"],
            ["Perch", simpleAdd, "harpyDamage, 1"],
            ["Striking Blade", simpleAdd, "strikeDamage, 2.5"],
            ["Healing Charm", simpleAdd, "heal, .5"],
            ["Motivating Tonic", simpleAdd, "attributePoints, 1"],
            ["Compass", simpleAdd, "startingFloor, 4"],
            ["Explorer's Map", simpleAdd, "startingFloor, 5"],
            ["Hunter's Map", simpleAdd, "startingFloor, 5"],
        ]

        function saveGame() {
            localStorage.setItem("playerData", JSON.stringify(player));
        }

        function loadGame() {
            if (localStorage.getItem("playerData") !== null) {
                player = JSON.parse(localStorage.getItem("playerData"));
                for (let x of player.completedStories) {
                    //                    runFunction(stories[x].onclear)
                    window[stories[x].onclear]()
                }
                for (let x of Object.keys(levelMilestones)) {
                    if (player.level >= parseInt(x)) { // && Object.keys(levelMilestones).includes(player.level.toString())
                        //                        activityLog += "<br> You've unlocked " + levelMilestones[player.level][0];
                        window[levelMilestones[x][1]]()

                    }
                }
                cleanShop()
                refreshStats()
            }
        }

        function clearGame() {
            localStorage.clear();
            location.reload();
        }

        function renameAction(actionlist, location) {

            actionlist = window[actionlist];
            if (actionlist[location] !== undefined) {
                document.getElementById(actionlist.actionid).innerHTML = actionlist[location][0];
            } else {
                document.getElementById(actionlist.actionid).innerHTML = "";
            }
        }

        function goArea(loc) {
            player.location = loc;
            if (areaTraits[loc] == undefined) {
                loc = "hub"
            }

            for (x of Object.keys(areaTraits[loc])) {
                r.style.setProperty(("--" + x), areaTraits[loc][x]);
            }
        }

        function goHub() {
            goArea("hub")
            player.choice = false;
            player.storyLocation = "";
            player.fightLocation = "";
            player.subArea = "";
            document.getElementById("inputBox").onkeypress = function() {
                return false
            };
            document.getElementById("inputBox").placeholder = " X X X X X X X X ";
            document.getElementById("inputBox").innerHTML = "";
            player.floor = player.startingFloor;
            let count_to_8 = [1, 2, 3, 4, 5, 6, 7, 8].map(String);
            for (let x of count_to_8) {
                renameAction(("action" + x + "List"), "hub");
            }
            refreshStats()
            //            document.getElementById("enemyStatus").innerHTML = "Coins:" + player.coins;
            saveGame()
            //            document.getElementById("playerStatus").innerHTML = "You are currently in the Hub. The path ahead is yours to define.";

        }

        function clickall(actionlist) {
            if (actionlist !== undefined && actionlist[player.location] !== undefined) {
                y = player.location;
                let funcname = (actionlist[y])[1];
                if (funcname !== "") {
                    if (actionlist[y].length >= 3) {
                        window[funcname](actionlist[y][2]);
                    } else {
                        runFunction(funcname)
                    }
                }
            }
            //            else {
            //               console.log("whoops the button that didn't exist was clicked :/")
            //            }
        }

        function refreshStats() {
            let myElement = document.getElementById("playerStats");
            for (let child of myElement.children) {
                let idname = child.id;
                if (idname == "SP") {
                    child.innerHTML = idname + ": " + player.skillUses;
                } else if (idname == "AP") {
                    child.innerHTML = idname + ": " + player.attributePoints;
                } else if (idname == "AP") { // uh, filler
                    child.innerHTML = idname + ": " + player.attributePoints;
                } else if (idname == "maxHealth") {
                    child.innerHTML = "Max Hp: " + player.maxHealth * 5;
                } else {
                    child.innerHTML = idname + ": " + player[idname];
                }


            }
            myElement = document.getElementById("enemyStats");
            for (let child of myElement.children) {
                let idname = child.id;
                if (idname == "SP") {
                    child.innerHTML = idname + ": " + player.skillUses;
                } else if (idname == "AP") {
                    child.innerHTML = idname + ": " + player.attributePoints;
                } else if (idname == "AP") { // uh, filler
                    child.innerHTML = idname + ": " + player.attributePoints;
                } else if (idname == "maxHealth") {
                    child.innerHTML = "Max Hp: " + player.maxHealth * 5;
                } else {
                    child.innerHTML = idname + ": " + Math.floor(player[idname]);
                }
            }
            document.getElementById("playerStatus").innerHTML = "Your Health:" + player.health;
            if (player.location == 'fight') {
                document.getElementById("enemyStatus").innerHTML = enemy.name + "'s Health:" + enemy.health;
            }
        }

        function fight(loc) {
            player.fightLocation = loc;
            player.xp += 0.2;
            //            let bounds = [8, 12]
            var bounds = [fightAreas[player.fightLocation][1][0], fightAreas[player.fightLocation][1][1]]
            enemy.name = fightAreas[player.fightLocation][0][Math.floor(Math.random() * fightAreas[player.fightLocation][0].length)];
            player.health = player.maxHealth * 5;
            player.fightLocation = loc;
            player.skillUses = player.skillUsesMax;
            enemy.status = "alive";
            enemy.health = Math.floor(player.floor * (getRandomInt(bounds[0], bounds[1]) / 10)) * 5
            enemy.attack = Math.floor(player.floor * (getRandomInt(bounds[0], bounds[1]) / 10))
            enemy.defense = Math.floor(player.floor * (getRandomInt(bounds[0], bounds[1]) / 10))
            if (enemy.defense == 0) {
                enemy.defense = 1
            }
            goArea("fight")
            refreshStats()
            let count_to_8 = [1, 2, 3, 4, 5, 6, 7, 8, ].map(String);
            for (let x of count_to_8) {

                renameAction(("action" + x + "List"), "fight");
            }
            combatLog += "<br> You've encountered " + enemy.name + " on floor " + player.floor + "!";
            document.getElementById("combatLog").innerHTML = combatLog;
            document.getElementById("playerStatus").innerHTML = "Your Health:" + player.health;
            document.getElementById("enemyStatus").innerHTML = enemy.name + "'s Health:" + enemy.health;


        }

        function attack() {
            if (enemy.status !== "dead" && enemy.health > 0) {
                enemy.health -= Math.floor((player.attack * 3) / enemy.defense);
                document.getElementById("enemyStatus").innerHTML = enemy.name + "'s Health:" + enemy.health;
                document.getElementById("playerStatus").innerHTML = "Your Health:" + player.health;
                combatLog += "<br>You've done " + Math.floor((player.attack * 3) / enemy.defense) + " damage!";
                document.getElementById("combatLog").innerHTML = combatLog;
                enemyTurn()
            } else {
                enemyDeath()
            }

        }

        function strike() {
            if (player.skillUses > 0) {
                if (enemy.status !== "dead" && enemy.health > 0) {
                    enemy.health -= Math.floor((player.attack * player.strikeDamage) / enemy.defense);
                    document.getElementById("enemyStatus").innerHTML = enemy.name + "'s Health:" + enemy.health;
                    document.getElementById("playerStatus").innerHTML = "Your Health:" + player.health;
                    combatLog += "<br>You've done " + Math.floor((player.attack * player.strikeDamage) / enemy.defense) + " damage!";
                    document.getElementById("combatLog").innerHTML = combatLog;
                    player.skillUses -= 1
                    refreshStats()
                    enemyTurn()
                } else {
                    refreshStats()
                    enemyDeath()
                }
            } else {
                if (enemy.status !== "dead" && enemy.health > 0) {
                    combatLog += "<br>not enough skill points, defaulting to basic attack.";
                    attack()
                    document.getElementById("combatLog").innerHTML = combatLog;
                    refreshStats()
                } else {
                    refreshStats()
                    enemyDeath()
                }
            }

        }

        function heal() {
            if (player.skillUses > 0) {
                if (enemy.status !== "dead" && enemy.health > 0) {
                    player.health += Math.floor(player.defense * 2.5 * player.heal);
                    document.getElementById("enemyStatus").innerHTML = enemy.name + "'s Health:" + enemy.health;
                    document.getElementById("playerStatus").innerHTML = "Your Health:" + player.health;
                    combatLog += "<br>You've healed " + Math.floor(player.defense * 2.5 * player.heal) + " health!";
                    document.getElementById("combatLog").innerHTML = combatLog;
                    player.skillUses -= 1
                    refreshStats()
                    enemyTurn()
                } else {
                    refreshStats()
                    enemyDeath()
                }
            } else {
                if (enemy.status !== "dead" && enemy.health > 0) {
                    combatLog += "<br>not enough skill points, defaulting to basic attack.";
                    attack()
                    document.getElementById("combatLog").innerHTML = combatLog;
                    refreshStats()
                } else {
                    refreshStats()
                    enemyDeath()
                }
            }

        }

        function curse() {
            if (player.skillUses > 0) {
                if (enemy.status !== "dead" && enemy.health > 0) {
                    enemy.defense = (Math.floor((enemy.defense / player.curse * player.attack) * 100) / 100);
                    refreshStats()
                    combatLogAdd("<br>The enemy's defense is " + enemy.defense + "!")
                    player.skillUses -= 1
                    refreshStats()
                    enemyTurn()
                } else {
                    refreshStats()
                    enemyDeath()
                }
            } else {
                if (enemy.status !== "dead" && enemy.health > 0) {
                    combatLog += "<br>not enough skill points, defaulting to basic attack.";
                    attack()
                    document.getElementById("combatLog").innerHTML = combatLog;
                    refreshStats()
                } else {
                    refreshStats()
                    enemyDeath()
                }
            }

        }

        function Harpyturn() {
            enemy.health -= Math.floor((player.coins * player.harpyDamage) / enemy.defense)
            combatLog += "<br>Your harpy has done " + Math.floor((player.coins * player.harpyDamage) / enemy.defense) + " damage!";
            document.getElementById("combatLog").innerHTML = combatLog;
        }

        function enemyTurn() {
            if (player.harpy == true) {
                Harpyturn()
            }
            if (enemy.status !== "dead" && enemy.health > 0) {
                player.health -= Math.floor(enemy.attack / player.defense)
                document.getElementById("playerStatus").innerHTML = "Your Health:" + player.health;
                combatLog += "<br>Your opponent has done " + Math.floor(Math.floor(enemy.attack / player.defense)) + " damage!";
                document.getElementById("combatLog").innerHTML = combatLog;
                if (player.health <= 0) {
                    levelUpCheck()
                    goHub()
                }
            }
        }

        function enemyDeath() {
            if (player.fightLocation == "dungeon") {
                enemy.status = "dead"
                player.coins += Math.floor(getRandomInt(0, player.floor))
                player.xp += Math.floor(getRandomInt(player.floor * 1, player.floor * 2))
                combatLog += "<br>You have " + Math.floor(player.xp) + " / " + player.neededXp + " Needed experience!";
                document.getElementById("combatLog").innerHTML = combatLog;
                levelUpCheck()

                player.floor += 1
                fight(player.fightLocation)

            }
        }

        function levelUpCheck() {
            if (player.xp >= player.neededXp) {
                player.xp -= player.neededXp;
                player.neededXp += 10;
                player.level += 1;
                player.attributePoints += 3;
                activityLog += "<br> You've levelled up!";
                for (let x of Object.keys(levelMilestones)) {
                    if (player.level.toString() == x) {
                        activityLog += "<br> You've unlocked " + levelMilestones[player.level][0];
                        window[levelMilestones[player.level][1]]()
                    }
                }
                document.getElementById("activityLog").innerHTML = activityLog;
            }
        }

        function attributeDistribute() {
            goArea("distrib")
            if (player.attributePoints > 0) {
                let count_to_8 = [1, 2, 3, 4, 5, 6, 7, 8].map(String);
                for (let x of count_to_8) {
                    renameAction(("action" + x + "List"), "distrib");
                }
            }
        }

        function simpleAdd(params) {
            params = params.split(", ")
            //            combatLog += "<br>"+params;
            //                document.getElementById("combatLog").innerHTML = combatLog; //test
            player[params[0]] += parseInt(params[1])
            refreshStats();
        }

        function addtosp() {
            if (player.attributePoints > 0) {
                player.attributePoints -= 1;
                player.skillUsesMax += 1;
                player.skillUses = player.skillUsesMax;
                refreshStats();
            } else {
                goHub()
            }
        }

        function addtoatt() {
            if (player.attributePoints > 0) {
                player.attributePoints -= 1;
                player.attack += 1;
                refreshStats();
            } else {
                goHub()
            }
        }

        function addtohp() {
            if (player.attributePoints > 0) {
                player.attributePoints -= 1;
                player.maxHealth += 1;
                refreshStats();
            } else {
                goHub()
            }
        }

        function addtodef() {
            if (player.attributePoints > 0) {
                player.attributePoints -= 1;
                player.defense += 1;
                refreshStats();
            } else {
                goHub()
            }
        }



        function logKey(e) {
            if ((String.fromCharCode(e.keyCode) == "Y" || String.fromCharCode(e.keyCode) == "n") && player.choice == true && player.location !== "shop") {
                if (String.fromCharCode(e.keyCode) == "Y") {
                    choiceYes()
                } else {
                    choiceNo();
                }
            } else if (String.fromCharCode(e.keyCode) in [1, 2, 3, 4, 5, 6, 7, 8, 9].map(String) && player.choice == false && player.location !== "shop") {
                if (player.location == "hub") {
                    if (e.repeat) {
                        return
                    }
                }
                clickall(window["action" + String.fromCharCode(e.keyCode) + "List"])
            } else { // CHEAT
                player.xp += 1000;
                player.coins += 1000;
            }
        }

        let box = document.getElementById("inputBox");
        box.addEventListener("keydown", function(e) {
            if (e.keyCode === 13) {
                inputEnter(e);
            }
        });

        function unlockHeal() {
            player.abilities.push(3)
            action3List.fight = ["|3| Heal", "heal"]
        }

        function unlockFlightCity() {
            action6List.hub = ["|6| Caelum Civitatem, Holy City of Flight", "goFlightCity"]
        }

        function goFlightCity() {
            goArea("flightCity")
            let count_to_8 = [1, 2, 3, 4, 5, 6, 7, 8].map(String);
            for (let x of count_to_8) {
                renameAction(("action" + x + "List"), "flightCity");
            }
        }

        function addHarpy() {
            player.harpy = true;
            action2List.flightCity = ["", ""];
            player.completedStories.push('flightCityHarpy')
            goHub()
        }

        function harpyClear() {
            action2List.flightCity = ["", ""];
        }


        function choiceYes() {
            storyIncrement(player.storyLocation, "y");
        }

        function choiceNo() {
            storyIncrement(player.storyLocation, "n");
        }

        function storyIncrement(story, choice = "none") {
            player.storyLocation = story;
            player.choice = true;
            stories[story].currentStoryPosition;
            if (typeof stories[story][stories[story].currentStoryPosition] !== 'string') {
                //                activityLog += "<br><br>" + stories[story][stories[story].currentStoryPosition][0];
                document.getElementById("storyLog").innerHTML = stories[story][stories[story].currentStoryPosition][0];
                if (choice == "none") {
                    stories[story].currentStoryPosition = stories[story][stories[story].currentStoryPosition][1][0]
                } else if (choice == "y") {
                    stories[story].currentStoryPosition = stories[story][stories[story].currentStoryPosition][1][0]
                } else if (choice == "n") {
                    stories[story].currentStoryPosition = stories[story][stories[story].currentStoryPosition][1][1]
                }
            } else {
                window[stories[story][stories[story].currentStoryPosition]]()
                if (stories[story].currentStoryPosition == 'finale') {
                    document.getElementById("storyLog").innerHTML = '';
                }
            }
        }

        function inputEnter() { //push inputbox value
            player.input = document.getElementById("inputBox").value;
            document.getElementById("inputBox").value = "";
            buyShopItem()
            goHub()
        }

        function resolveAfterSeconds(sec) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve('resolved');
                }, sec);
            });
        }

        async function goShop() {
            cleanShop()


            let count_to_8 = [1, 2, 3, 4, 5, 6, 7, 8].map(String);
            for (let x of count_to_8) {
                renameAction(("action" + x + "List"), "shop");
            }
            goArea("shop")
            activityLog += "<br>" + "Buyable Items 50 Coins each, use Input Box)";
            document.getElementById("activityLog").innerHTML = activityLog;

            combatLog += '<hr style="border: none;">'
            for (let index of items) {
                if (index !== "") {
                    combatLog += "<br>" + (items.indexOf(index) + 1) + ": " + index[0];
                    document.getElementById("combatLog").innerHTML = combatLog;
                }
            }
            document.getElementById("inputBox").onkeypress = function() {
                return true
            };
            document.getElementById("inputBox").placeholder = "-|-|-";
            document.getElementById("inputBox").innerHTML = "";
            const result = await resolveAfterSeconds(1);
            document.getElementById("inputBox").focus();
        }

        function buyShopItem() {
            if (isInteger(player.input)) { // fix
                boughtitem = parseInt(player.input) - 1;
                if (player.coins >= 50 && boughtitem >= 0 && boughtitem < items.length) {
                    if (items[boughtitem] !== "") {
                        if (items[boughtitem][2] !== "") {
                            items[boughtitem][1](items[boughtitem][2])
                        } else {
                            items[boughtitem][1]()
                        }
                        player.items.push(boughtitem);
                        player.coins -= 50;
                        combatLog += "<br>" + items[boughtitem][0] + " Bought.";
                        document.getElementById("combatLog").innerHTML = combatLog;
                        document.getElementById("enemyStatus").innerHTML = "Coins:" + player.coins;
                        refreshStats()
                    }
                }
            }

            blurAll()
        }

        function cleanShop() {
            if (player.items !== undefined) {
                for (let item of player.items) {
                    items[item] = "";
                }
            }
        }

        function goSettings() {
            goArea("settings")
            let count_to_8 = [1, 2, 3, 4, 5, 6, 7, 8].map(String);
            for (let x of count_to_8) {
                renameAction(("action" + x + "List"), "settings");
            }
        }
        document.body.addEventListener("keydown", logKey);
        loadGame()
        //        goHub();
        runFunction('goHub')

    </script>

</body>

</html>
